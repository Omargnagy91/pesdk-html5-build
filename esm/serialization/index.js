import{B as S,F as X,I as c,Z as f,c as h,e as O,j as b,s as $}from"../chunk.44PRRM6L.js";var F="@photoeditorsdk/root",P="5.7.0",M="The most comprehensive photo editor SDK for HTML5",j="http://github.com/imgly/pesdk-html5",E="PhotoEditorSDK (img.ly GmbH) <contact@img.ly>",A="SEE LICENSE IN LICENSE.md",D=!0,H={},L={start:"yarn workspace @example/react start",build:"yarn sdk-script build","build:rollup":"yarn sdk-script build rollup","package:release":"cd dist/photoeditorsdk && npm publish","package:pre-release":"cd dist/photoeditorsdk && npm publish --tag next","lint:css":"stylelint './packages/**/*.tsx'","lint:ts":"eslint ./","lint:types":"tsc --noEmit -p tsconfig.json --skipLibCheck",lint:"yarn lint:ts && yarn lint:css && yarn lint:types",test:"$(npm bin)/jest",e2e:"cypress open","e2e:server":"sdk-script ui -P 3000 -D build","e2e:ci":"cypress run --browser chrome --headless",deploy:"yarn workspace examp run deploy:pages",docs:"rm -rf ./docs && typedoc"},V={"@elv1n/cypress-plugin-snapshots":"1.4.4","@testing-library/react":"^8.0.4","@types/jest":"^24.0.11","@types/pixelmatch":"^5.2.2","@types/pngjs":"^3.4.2","@types/react":"^16.8.13","@types/react-dom":"^16.8.4","@types/styled-components":"4.4.0","@typescript-eslint/eslint-plugin":"2.22.0","@typescript-eslint/parser":"2.22.0",autoprefixer:"^9.7.4","cross-env":"^7.0.2",cypress:"5.2.0",eslint:"7.10.0","eslint-config-airbnb":"18.2.0","eslint-config-prettier":"6.12.0","eslint-plugin-cypress":"^2.11.2","eslint-plugin-import":"2.22.1","eslint-plugin-jsx-a11y":"6.3.1","eslint-plugin-no-only-tests":"^2.4.0","eslint-plugin-prettier":"3.1.4","eslint-plugin-react":"7.21.3",husky:"4.3.0",jest:"^24.7.1","jest-axe":"^3.2.0","jest-dom":"^3.1.3",jsdoc:"^3.6.3","json-loader":"^0.5.7","lint-staged":"10.4.0","local-web-server":"^4.2.1","lodash.defaults":"^4.2.0","mobx-react-devtools":"^6.1.1","node-sass":"^4.14.1","node-static":"^0.7.10","npm-run-all":"^4.1.5","optimize-css-assets-webpack-plugin":"^3.2.0",prettier:"^2.0.5",react:"^16.3.2","react-dom":"^16.3.2","start-server-and-test":"^1.11.4","styled-components":"4.4.1",stylelint:"^13.2.0","stylelint-config-recommended":"^3.0.0","stylelint-config-standard":"^20.0.0","stylelint-config-styled-components":"^0.1.1","stylelint-processor-styled-components":"^1.10.0","ts-jest":"^24.0.2",typedoc:"^0.17.8",typescript:"3.8.3","utility-types":"^3.10.0"},B={"@juggle/resize-observer":"3.1.3","can-use-dom":"0.1.0","lodash.debounce":"4.0.8","lodash.memoize":"4.1.2","lodash.throttle":"4.1.1",mobx:"4.14.1","mobx-react":"5.4.4",photoeditorsdk:"1.0.0","react-app-polyfill":"1.0.6"},G={node:"8.x || 9.x || 10.x || 11.x || 12.x"},N={eslint:"7.10.0"},U=["examples/server","examples/material-ui","examples/react","packages/**/","engine/*","test/*","scripts"],_={hooks:{"pre-commit":"lint-staged","pre-push":"true"}},k={name:F,version:P,description:M,repository:j,author:E,license:A,private:D,bin:H,scripts:L,devDependencies:V,dependencies:B,devEngines:G,resolutions:N,workspaces:U,husky:_};const K=(e=O.PNG)=>`data:${e};base64,`;class u{constructor(e,i,o,n,r,s){this.mapImagePointToRelativeCropPoint=e=>{const i=f.pointFromSpaceToSpace(e,this.imageSpace,this.cropSpace,!1);return f.absoluteToRelativePoint(i,this.cropSpace,!1)};this.mapSizeToRelativeUnscaledCropSize=e=>e/Math.min(this.outputSize.height,this.outputSize.width);this.mapSizeToRelativeScaledCropSize=e=>e/Math.min(this.outputSize.height*this.outputScale.x,this.outputSize.width*this.outputScale.y);this.getPointInDirection=(e,i=0,o=3)=>{const n=Math.tan(i),r=Math.sqrt(n**2+1);return{x:e.x+o/r,y:e.y+o*n/r}};this.previewPosition=e,this.previewSize=i,this.outputSize=o,this.imageSize=n,this.imageSpace=r,this.cropSpace=s,this.outputScale=s.getScale()}static serializeFilters(e){return{type:"filter",options:{intensity:e.intensity,identifier:e.identifier}}}static serializeAdjustments(e){return{type:"adjustments",options:e}}static serializeOverlay(e){return{type:"overlay",options:{identifier:e.identifier,intensity:e.opacity,blendMode:e.blendMode.replace(/[A-Z]/g,i=>` ${i.toLowerCase()}`)}}}static serializeMetaData(){return{platform:"html5",version:k.version,createdAt:new Date().toISOString()}}serialise(e,i,o){const n=u.serializeMetaData(),r={width:this.imageSize.width,height:this.imageSize.height};i&&(r.type=o,r.data=i);const s=[],t=[],{adjustment:d}=e;Object.keys(d).map(a=>d[a]).filter(Boolean).length&&s.push(u.serializeAdjustments(d));const{filter:T}=e;T.identifier!=="identity"&&s.push(u.serializeFilters(T));const{overlay:C}=e;if(C.identifier!=="identity"&&t.push(u.serializeOverlay(C)),e.transform){const{transform:a,orientation:m}=this.serializeTransform(e.transform),v=[a.options.start.x!==0,a.options.start.y!==0,a.options.end.x!==1,a.options.end.y!==1,a.options.rotation!==0],y=[m.options.rotation!==0,m.options.flipVertically!==!1,m.options.flipHorizontally!==!1];v.some(z=>z)&&s.push(a),y.some(z=>z)&&s.push(m)}const{frame:R}=e;R.identifier!=="identity"&&t.push(this.serialzeFrame(R));const{focus:I}=e;if(I.identifier!=="identity"&&s.push(this.serializeFocus(I)),e.sprite&&e.sprite.spriteIdList.forEach(a=>{const m=e.sprite.common[a];switch(m.tool){case"sticker":const v=e.sprite.sticker[a];t.push(this.serializeSticker(v,m,e.transform));break;case"text":const y=e.sprite.text[a];t.push(this.serializeText(y,m));break;case"textdesign":const z=e.sprite.textdesign[a];t.push(this.serializeTextDesign(z,m));break}}),e.brush.strokes.length&&t.push({type:"brush",options:{paths:e.brush.strokes.map(a=>({points:a.path.controlPoints.map(this.mapImagePointToRelativeCropPoint),brush:{color:{rgba:a.brush.color},size:a.brush.size,hardness:a.brush.hardness}}))}}),t.length){const a={type:"sprite",options:{sprites:t}};s.push(a)}const x=e.customStickers?e.customStickers.map(a=>c(c({},a),{raster:c(c({},a.raster),{data:a.raster.data.replace(K(a.raster.type),"")})})):[],w={assets:{stickers:x}};return{version:u.version,meta:n,image:r,operations:s,assetLibrary:w}}serialzeFrame(e){return{type:"frame",options:{identifier:e.identifier,alpha:e.opacity,tintColor:{rgba:e.color},size:this.mapSizeToRelativeUnscaledCropSize(e.width)}}}serializeFocus(e){const i=Math.sqrt(this.previewSize.width**2+this.previewSize.height**2);switch(e.identifier){case b.LINEAR:return{type:"focus",options:{type:"linear",options:{start:this.mapImagePointToRelativeCropPoint(e.linear.start),end:this.mapImagePointToRelativeCropPoint(e.linear.end),blurRadius:this.mapSizeToRelativeScaledCropSize(e.linear.blurRadius)}}};case b.RADIAL:return{type:"focus",options:{type:"radial",options:{start:this.mapImagePointToRelativeCropPoint(e.radial.center),end:this.mapImagePointToRelativeCropPoint(this.getPointInDirection(e.radial.center,0,e.radial.radius)),blurRadius:this.mapSizeToRelativeScaledCropSize(e.radial.blurRadius),gradientRadius:.1}}};case b.MIRRORED:const{mirrored:o}=e;return{type:"focus",options:{type:"mirrored",options:{start:this.mapImagePointToRelativeCropPoint(this.getPointInDirection(o.origin,o.rotation,i/2)),end:this.mapImagePointToRelativeCropPoint(this.getPointInDirection(o.origin,o.rotation,-i/2)),size:this.mapSizeToRelativeScaledCropSize(e.mirrored.size),blurRadius:this.mapSizeToRelativeScaledCropSize(e.mirrored.blurRadius),gradientSize:.1}}};default:return{type:"focus",options:{type:"gaussian",options:{blurRadius:this.mapSizeToRelativeScaledCropSize(e.gaussian.blurRadius)}}}}}serializeSticker(e,i,o){return{type:"sticker",options:{position:this.mapImagePointToRelativeCropPoint(i.position),dimensions:{x:this.mapSizeToRelativeScaledCropSize(i.size.width),y:this.mapSizeToRelativeScaledCropSize(i.size.height)},rotation:i.rotation,flipVertically:(i.flipVertically||!1)!==(o.flipVertically||!1),flipHorizontally:(i.flipHorizontally||!1)!==(o.flipHorizontally||!1),identifier:e.identifier,alpha:e.opacity,tintColor:{rgba:e.tintColor},tintMode:e.tintMode}}}serializeText(e,i){return{type:"text",options:{position:this.mapImagePointToRelativeCropPoint(i.position),rotation:i.rotation,flipVertically:!1,flipHorizontally:!1,fontIdentifier:e.identifier,fontSize:this.mapSizeToRelativeScaledCropSize(e.fontSize),maxWidth:this.mapSizeToRelativeScaledCropSize(e.width),text:e.text,lineHeight:e.lineHeight,color:{rgba:e.textColor},backgroundColor:{rgba:e.backgroundColor},alignment:e.alignment}}}serializeTextDesign(e,i){return{type:"textdesign",options:{position:this.mapImagePointToRelativeCropPoint(i.position),rotation:i.rotation,flipVertically:!1,flipHorizontally:!1,identifier:e.identifier,inverted:e.isInverted,text:e.text,seed:e.seed,width:this.mapSizeToRelativeScaledCropSize(e.width),padding:this.mapSizeToRelativeScaledCropSize(e.padding),color:{rgba:e.color}}}}serializeTransform(e){const{start:i,end:o}=e,n={type:"transform",options:{start:i,end:o,rotation:e.rotation,meta:{identifier:e.identifier}}},r={type:"orientation",options:{rotation:e.outputRotation,flipHorizontally:e.flipHorizontally,flipVertically:e.flipVertically}};return{transform:n,orientation:r}}}u.version="3.9.0";const g=(e=O.PNG)=>`data:${e};base64,`;class p{constructor(e){this.spriteOrder=0;this.mapRelativeCropPointToImageSpace=e=>{const i=f.relativeToAbsolutePoint(e,this.cropSpace,!1);return f.pointFromSpaceToSpace(i,this.cropSpace,this.imageSpace,!1)};this.mapRelativeCropSizeToScaledImageSize=e=>e*Math.min(this.outputSize.height*this.outputScale.x,this.outputSize.width*this.outputScale.y);this.mapRelativeCropSizeToUnscaledImageSize=e=>e*Math.min(this.outputSize.height,this.outputSize.width);this.editor=e}static deserializeFilter(e){return{intensity:e.intensity,identifier:e.identifier}}static deserializeAdjustments(e){return c({},e)}static deserializeOverlay(e){return{identifier:e.identifier,opacity:e.intensity,blendMode:e.blendMode.replace(/([ _][a-z])/g,i=>i.toUpperCase().replace(" ","").replace("_",""))}}static initializeEmptyTransform(){return{outputRotation:0,flipHorizontally:!1,flipVertically:!1,start:{x:0,y:0},end:{x:1,y:1},rotation:0}}static deserialzeColor(e){return e&&e.rgba?e.rgba:[0,0,0,0]}static validateVersion(e){return p.version===e}static checkIfPlatformHTML(e){return e==="html5"}static deserializeStickers(e){return{identifier:e.identifier,opacity:e.alpha||0,tintMode:e.tintMode||"none",tintColor:p.deserialzeColor(e.tintColor)}}static checkIsSerialisationValid(e){if(typeof e!="string"&&p.validateVersion(e.version))return!0;if(typeof e=="string")throw new Error("Invalid input of type string, please provide an object");return!1}static deserializeImage(e){const i={};return e.image&&(i.image={width:e.image.width,height:e.image.height,data:e.image.data?e.image.data.replace(g(),""):""},i.image.data=i.image.data?g()+i.image.data:""),i}deserializeTransformation(e){const i={},o=e.operations.find(s=>s.type==="orientation"),n=e.operations.find(s=>s.type==="transform"),[r]=this.editor.engine.getRootContainers();return this.previewPosition=this.editor.transformToolStore.defaultCropMaskPosition,this.previewSize=this.editor.transformToolStore.maxCropMaskSize,this.imageSpace=r,i.transform=p.initializeEmptyTransform(),o!=null&&(i.transform.outputRotation=o.options.rotation,i.transform.flipHorizontally=o.options.flipHorizontally||!1,i.transform.flipVertically=o.options.flipVertically||!1),n&&(i.transform.start=n.options.start,i.transform.end=n.options.end,i.transform.rotation=n.options.rotation||0,i.transform.identifier=n.options.meta?n.options.meta.identifier:""),i}deserialize(e){const i={};(e.meta?!p.checkIfPlatformHTML(e.meta.platform):!1)&&console.warn("Read serialisation from another Platform");const o=this.editor.engineMediator.output.container.getResolution(),{size:n}=this.editor.engineMediator.image.container.getBounds();return this.outputSize=o,this.imageSize=n,this.cropSpace=this.editor.engine.getOutputContainer(),this.outputScale=this.cropSpace.getScale(),e.operations.forEach(r=>{switch(r.type){case"filter":i.filter=p.deserializeFilter(r.options);break;case"adjustments":i.adjustment=p.deserializeAdjustments(r.options);break;case"focus":i.focus=this.deserializeFocus(r.options);break;case"sprite":const{sprites:s}=r.options;s.forEach(t=>{switch(t.type){case"frame":i.frame=this.deserializeFrame(t.options);break;case"overlay":i.overlay=p.deserializeOverlay(t.options);break;case"brush":i.brush?i.brush.strokes.push(...this.deserializeBrush(t.options).strokes):i.brush=this.deserializeBrush(t.options);break;case"sticker":case"text":case"textdesign":i.sprite||(i.sprite={spriteIdList:[],sticker:{},text:{},textdesign:{},common:{}});const d=X();i.sprite.spriteIdList.push(d),i.sprite.common[d]={order:this.spriteOrder,position:this.mapRelativeCropPointToImageSpace(t.options.position),tool:h.STICKER,rotation:t.options.rotation||0,flipHorizontally:t.options.flipHorizontally,flipVertically:t.options.flipVertically},this.spriteOrder+=1,t.type===h.STICKER?(i.sprite.common[d].tool=h.STICKER,i.sprite.common[d].size={width:this.mapRelativeCropSizeToScaledImageSize(t.options.dimensions.x),height:this.mapRelativeCropSizeToScaledImageSize(t.options.dimensions.y)},i.sprite.sticker[d]=p.deserializeStickers(t.options)):t.type===h.TEXT?(i.sprite.common[d].tool=h.TEXT,i.sprite.text[d]=this.deserializeTexts(t.options)):t.type===h.TEXT_DESIGN&&(i.sprite.common[d].tool=h.TEXT_DESIGN,i.sprite.textdesign[d]=this.deserializeTextDesign(t.options));break;default:break}});break;default:break}}),e.assetLibrary&&(i.customStickers=e.assetLibrary&&e.assetLibrary.assets&&e.assetLibrary.assets.stickers||[],i.customStickers=i.customStickers.map(r=>{const s=r.raster.data.replace(g(r.raster.type),"");return c(c({},r),{raster:c(c({},r.raster),{data:g(r.raster.type)+s})})})),i}deserializeFrame(e){return{identifier:e.identifier,opacity:e.alpha,width:this.mapRelativeCropSizeToUnscaledImageSize(e.size),color:p.deserialzeColor(e.tintColor)}}deserializeFocus(e){switch(e.type){case"linear":return{identifier:"linear",linear:this.deserializeLinearFocus(e.options)};case"gaussian":return{identifier:"gaussian",gaussian:this.deserializeGaussianFocus(e.options)};case"radial":return{identifier:"radial",radial:this.deserializeRadialFocus(e.options)};case"mirrored":return{identifier:"mirrored",mirrored:this.deserializeMirroredFocus(e.options)}}return}deserializeRadialFocus(e){return{center:this.mapRelativeCropPointToImageSpace(e.start),radius:new S(this.mapRelativeCropPointToImageSpace(e.start)).subtract(new S(this.mapRelativeCropPointToImageSpace(e.end))).magnitude,blurRadius:this.mapRelativeCropSizeToScaledImageSize(e.blurRadius)}}deserializeLinearFocus(e){return{start:this.mapRelativeCropPointToImageSpace(e.start),end:this.mapRelativeCropPointToImageSpace(e.end),blurRadius:this.mapRelativeCropSizeToScaledImageSize(e.blurRadius)}}deserializeGaussianFocus(e){return{blurRadius:this.mapRelativeCropSizeToScaledImageSize(e.blurRadius)}}deserializeMirroredFocus(e){const i=new S(this.mapRelativeCropPointToImageSpace(e.start)).subtract(new S(this.mapRelativeCropPointToImageSpace(e.end)));return{origin:new S(this.mapRelativeCropPointToImageSpace(e.start)).add(new S(this.mapRelativeCropPointToImageSpace(e.end))).divide(2),rotation:Math.atan2(i.y,i.x),size:this.mapRelativeCropSizeToScaledImageSize(e.size),blurRadius:this.mapRelativeCropSizeToScaledImageSize(e.blurRadius)}}deserializeTexts(e){return{identifier:$(e.fontIdentifier),fontSize:this.mapRelativeCropSizeToScaledImageSize(e.fontSize),width:this.mapRelativeCropSizeToScaledImageSize(e.maxWidth),alignment:e.alignment,textColor:p.deserialzeColor(e.color),backgroundColor:p.deserialzeColor(e.backgroundColor),lineHeight:e.lineHeight,text:e.text}}deserializeTextDesign(e){return{identifier:e.identifier,width:this.mapRelativeCropSizeToScaledImageSize(e.width),padding:this.mapRelativeCropSizeToScaledImageSize(e.padding),color:p.deserialzeColor(e.color),seed:e.seed,text:e.text,isInverted:e.inverted}}deserializeBrush(e){return{strokes:e.paths.map(i=>({path:{controlPoints:i.points.map(this.mapRelativeCropPointToImageSpace)},brush:{id:"imgly_brush_radial",color:p.deserialzeColor(i.brush.color),size:i.brush.size,hardness:i.brush.hardness}}))}}}p.version="3.9.0";export{p as Deserializer,u as Serializer};
